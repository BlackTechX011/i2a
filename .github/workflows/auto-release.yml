name: Auto Release (Debounced)

on:
  push:
    branches: [ "main" ]

# This checks if a build is already running for 'main'. 
# If a new commit comes in, it kills the old one and starts over.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
    # 1. The "Wait" Logic (Debounce)
    # We wait 2 minutes. If a new commit is pushed during this time, 
    # the 'concurrency' setting above kills this job and starts a new one.
    - name: â³ Wait for stability (2m)
      run: Start-Sleep -Seconds 120
      shell: powershell

    # 2. Checkout Code
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    # 3. Setup Rust
    - name: ðŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        target: x86_64-pc-windows-msvc

    # 4. Build the EXE
    - name: ðŸ”¨ Build Release
      run: cargo build --release --verbose

    # 5. Create a Version Tag
    # Generates a version like v1.0.45 based on the run number
    - name: ðŸ·ï¸ Generate Version Tag
      id: tag_version
      run: |
        echo "VERSION=v1.0.${{ github.run_number }}" >> $env:GITHUB_ENV
        echo "Detected Version: v1.0.${{ github.run_number }}"
      shell: powershell

    # 6. Package the zip
    # We zip the EXE and the README
    - name: ðŸ“¦ Create Zip Package
      run: |
        mkdir release
        copy target/release/i2a.exe release/
        copy README.md release/
        Compress-Archive -Path release/* -DestinationPath i2a_windows_x64.zip
      shell: powershell

    # 7. Create GitHub Release
    - name: ðŸš€ Publish Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: Release ${{ env.VERSION }}
        body: |
          ### ðŸš€ Auto-Build ${{ env.VERSION }}
          
          **Changes in this build:**
          ${{ github.event.head_commit.message }}
          
          ---
          *Automated release by i2a CI*
        files: |
          i2a_windows_x64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}